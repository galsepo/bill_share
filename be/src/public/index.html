<!DOCTYPE html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma-rtl.min.css"
    />
  </head>
  <body class="container is-max-desktop mt-6">
    <h1 class="is-size-1">popo</h1>
    <form id="start-new-party" class="mt-5" action="">
      <label class="label">
        Enter your name
        <input class="input" type="text" name="username" />
      </label>
      <button type="submit" class="button">Start party</button>
    </form>
    <form id="join-existing" class="mt-5" action="">
      <label class="label">
        Enter your name
        <input class="input" type="text" name="username" />
      </label>
      <label class="label">
        Enter your party code
        <input class="input" type="text" name="partyId" />
      </label>
      <button type="submit" class="button">Join party</button>
    </form>
    <script src="https://cdn.socket.io/4.3.1/socket.io.min.js"></script>
    <script>
      var startNewPartyForm = document.forms[0];
      var joinExistingPartyForm = document.forms[1];
      var socket = io();

      startNewPartyForm.addEventListener("submit", async (e) => {
        const input = startNewPartyForm.elements[0];
        e.preventDefault();
        input.classList.remove("is-danger");

        if (input.value) {
          const response = await fetch(`/party`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              // 'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: JSON.stringify({
              username: input.value,
            }),
          });

          if (response.ok) {
            const data = await response.text();
            window.location = `/party/${data}`;
          } else {
            console.log(response.status);
          }
        } else {
          input.classList.add("is-danger");
        }
      });

      joinExistingPartyForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = joinExistingPartyForm.elements[0];
        const partyId = joinExistingPartyForm.elements[1];
        username.classList.remove("is-danger");

        if (username.value) {
          const response = await fetch(`/party/${partyId.value}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              // 'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: JSON.stringify({
              username: username.value,
            }),
          });

          if (response.ok) {
            const data = await response.text();
            socket.emit("user join", {
              username: username.value,
              partyId: partyId.value,
            });
            window.location = `/party/${data}`;
          } else {
            console.log(response.status);
          }
        } else {
          username.classList.add("is-danger");
        }
      });
    </script>
  </body>
</html>
